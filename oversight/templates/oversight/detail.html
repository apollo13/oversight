{% extends 'oversight/page.html' %}
{% load static from staticfiles %}

{% block content %}
<div class="row">
  <div class="small-12 columns">
    <h3>Details for {{ sensor.name }}</h3>
    <p>Last updated {{ sensor_data.0.datetime }}</p>
    <table>
      <thead>
        <tr>
          <th>sensor value</th>
          <th>time</th>
        </tr>
      </thead>
      <tbody>
      {% for log in sensor_data %}
        <tr>
          <td>{{ log.value }} {{ sensor.unit }}</td>
          <td>{{ log.datetime|date:"SHORT_DATETIME_FORMAT" }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
    <div id="chart" style="width:900px; height:700px;"></div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ block.super }}
<script language="javascript" type="text/javascript" src="{% static 'jqplot/jquery.jqplot.js' %}"></script>
<script type="text/javascript" language="javascript" src="{% static 'jqplot/plugins/jqplot.dateAxisRenderer.js' %}"></script>
<script type="text/javascript" language="javascript" src="{% static 'jqplot/plugins/jqplot.logAxisRenderer.js' %}"></script>
<script type="text/javascript" language="javascript" src="{% static 'jqplot/plugins/jqplot.canvasTextRenderer.min.js' %}"></script>
<script type="text/javascript" language="javascript" src="{% static 'jqplot/plugins/jqplot.canvasAxisTickRenderer.min.js' %}"></script>
<script type="text/javascript" language="javascript" src="{% static 'jqplot/plugins/jqplot.categoryAxisRenderer.min.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'jqplot/jquery.jqplot.css' %}" />
<script>
  var log_plot = {{ sensor.log_plot|yesno:"1,0" }};
  $(document).ready(function(){

    var ajaxDataRenderer = function(url, plot, options) {
      var ret = null;
      $.ajax({
        async: false,
        url: url,
        dataType:"json",
        success: function(data) {
          ret = $.map(data, function(elem, index) {
            return [[new Date(elem[0]), parseFloat(elem[1])]];
          });
        }
      });
      console.debug(ret.length);
      return [ret];
    };

    // The url for our json data
    var jsonurl = "{% url 'oversight_sensor_detail' sensor.api_endpoint %}?format=json";

    // passing in the url string as the jqPlot data argument is a handy
    // shortcut for our renderer.  You could also have used the
    // "dataRendererOptions" option to pass in the url.
    var yaxis = {};
    if (log_plot) {
      yaxis = {
        renderer: $.jqplot.LogAxisRenderer,
        tickOptions: {
          formatString: "%.2e",
        }
      };
    }
    var plot2 = $.jqplot('chart', jsonurl, {
      title: "",
      dataRenderer: ajaxDataRenderer,
      dataRendererOptions: {
        unusedOptionalUrl: jsonurl
      },
      axes: {
        xaxis: {
          renderer:$.jqplot.DateAxisRenderer,
          tickRenderer: $.jqplot.CanvasAxisTickRenderer,
          tickOptions: {
            angle: -30,
            fontSize: '10pt'
          }
        },
        yaxis: yaxis
      },
      series: [{showMarker: false}],
    });
  });
</script>
{% endblock scripts %}
